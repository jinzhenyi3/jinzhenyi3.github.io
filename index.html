<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub单点登录API</title>
    <style>
        :root {
            --primary-color: #24292e;
            --secondary-color: #0366d6;
            --accent-color: #28a745;
            --light-color: #f6f8fa;
            --border-color: #e1e4e8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fafbfc;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            color: var(--primary-color);
        }
        
        .card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #000;
        }
        
        .btn-github {
            background-color: var(--accent-color);
        }
        
        .btn-github:hover {
            background-color: #269f42;
        }
        
        .user-info {
            display: none;
        }
        
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 20px;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .info-item {
            padding: 10px;
            background-color: var(--light-color);
            border-radius: 4px;
        }
        
        .label {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .code-block {
            background-color: #f6f8fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
        }
        
        .step {
            margin-bottom: 25px;
        }
        
        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 10px;
        }
        
        .error {
            color: #cb2431;
            background-color: #ffeef0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>GitHub单点登录API</h1>
        <p>使用Cloudflare Workers搭建的GitHub OAuth登录API，返回用户JSON数据</p>
    </header>
    
    <div class="card">
        <h2>演示</h2>
        <div id="login-section">
            <p>点击下方按钮通过GitHub登录：</p>
            <button class="btn btn-github" id="login-btn">通过GitHub登录</button>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="user-info" class="user-info">
            <div class="user-details">
                <img id="avatar" class="avatar" src="" alt="用户头像">
                <div>
                    <h2 id="name"></h2>
                    <p id="bio"></p>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">注册天数：</span>
                    <span id="account-age"></span>
                </div>
                <div class="info-item">
                    <span class="label">粉丝数：</span>
                    <span id="followers"></span>
                </div>
                <div class="info-item">
                    <span class="label">GitHub主页：</span>
                    <a id="profile-url" target="_blank">访问</a>
                </div>
                <div class="info-item">
                    <span class="label">API响应：</span>
                    <button class="btn" id="show-json">查看JSON</button>
                </div>
            </div>
            
            <div id="json-output" class="code-block" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>
    
    <div class="card">
        <h2>Cloudflare Worker后端代码</h2>
        
        <div class="step">
            <h3><span class="step-number">1</span>创建GitHub OAuth应用</h3>
            <p>在GitHub开发者设置中创建OAuth应用，获取Client ID和Client Secret。</p>
            <p>设置授权回调URL为：<code>https://your-worker.your-subdomain.workers.dev/oauth/callback</code></p>
        </div>
        
        <div class="step">
            <h3><span class="step-number">2</span>Cloudflare Worker代码</h3>
            <p>将以下代码部署到Cloudflare Workers：</p>
            <div class="code-block">
// Cloudflare Worker代码 - GitHub OAuth登录API
const CLIENT_ID = "你的GitHub客户端ID";
const CLIENT_SECRET = "你的GitHub客户端密钥";
const REDIRECT_URI = "https://your-worker.your-subdomain.workers.dev/oauth/callback";

async function handleRequest(request) {
  const url = new URL(request.url);
  
  // 处理OAuth回调
  if (url.pathname === "/oauth/callback") {
    const code = url.searchParams.get("code");
    if (!code) {
      return new Response("Missing authorization code", { status: 400 });
    }
    
    try {
      // 交换code获取access token
      const tokenResponse = await fetch("https://github.com/login/oauth/access_token", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
          code: code
        })
      });
      
      const tokenData = await tokenResponse.json();
      const accessToken = tokenData.access_token;
      
      if (!accessToken) {
        return new Response("Failed to get access token: " + JSON.stringify(tokenData), { status: 400 });
      }
      
      // 使用access token获取用户信息
      const userResponse = await fetch("https://api.github.com/user", {
        headers: {
          "Authorization": `token ${accessToken}`,
          "User-Agent": "Cloudflare-Workers-Github-OAuth"
        }
      });
      
      if (!userResponse.ok) {
        return new Response("Failed to fetch user data: " + await userResponse.text(), { status: 500 });
      }
      
      const userData = await userResponse.json();
      
      // 计算注册天数
      const createdAt = new Date(userData.created_at);
      const now = new Date();
      const accountAgeDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
      
      // 构建响应JSON
      const responseData = {
        name: userData.name || userData.login,
        bio: userData.bio || "No biography provided",
        account_age_days: accountAgeDays,
        followers: userData.followers,
        avatar_url: userData.avatar_url,
        html_url: userData.html_url
      };
      
      // 返回JSON数据
      return new Response(JSON.stringify(responseData, null, 2), {
        headers: {
          "Content-Type": "application/json",
          "Access-Control-Allow-Origin": "*"
        }
      });
    } catch (error) {
      return new Response("Error: " + error.message, { status: 500 });
    }
  }
  
  // 处理登录请求
  if (url.pathname === "/login") {
    const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=read:user`;
    return Response.redirect(authUrl);
  }
  
  // 默认响应
  return new Response(JSON.stringify({
    message: "GitHub OAuth API",
    endpoints: {
      login: "/login",
      callback: "/oauth/callback"
    }
  }), {
    headers: {
      "Content-Type": "application/json",
      "Access-Control-Allow-Origin": "*"
    }
  });
}

addEventListener("fetch", event => {
  event.respondWith(handleRequest(event.request));
});
            </div>
        </div>
        
        <div class="step">
            <h3><span class="step-number">3</span>API响应格式</h3>
            <p>API返回的JSON数据格式如下：</p>
            <div class="code-block">
{
  "name": "用户名",
  "bio": "用户简介",
  "account_age_days": 注册天数,
  "followers": 粉丝数,
  "avatar_url": "头像链接",
  "html_url": "GitHub主页链接"
}
            </div>
        </div>
    </div>

    <script>
        // 配置您的Cloudflare Worker URL
        const WORKER_URL = "https://your-worker.your-subdomain.workers.dev";
        
        document.getElementById('login-btn').addEventListener('click', function() {
            // 重定向到Worker的登录端点
            window.location.href = `${WORKER_URL}/login`;
        });
        
        document.getElementById('show-json').addEventListener('click', function() {
            const jsonOutput = document.getElementById('json-output');
            if (jsonOutput.style.display === 'none') {
                // 显示当前用户数据的JSON
                const userData = {
                    name: document.getElementById('name').textContent,
                    bio: document.getElementById('bio').textContent,
                    account_age_days: parseInt(document.getElementById('account-age').textContent),
                    followers: parseInt(document.getElementById('followers').textContent),
                    avatar_url: document.getElementById('avatar').src,
                    html_url: document.getElementById('profile-url').href
                };
                jsonOutput.textContent = JSON.stringify(userData, null, 2);
                jsonOutput.style.display = 'block';
            } else {
                jsonOutput.style.display = 'none';
            }
        });
        
        // 检查URL中是否有授权码
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
            // 如果有授权码，则获取访问令牌和用户信息
            fetch(`${WORKER_URL}/oauth/callback?code=${code}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(userData => {
                    // 显示用户信息
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    
                    document.getElementById('avatar').src = userData.avatar_url;
                    document.getElementById('name').textContent = userData.name;
                    document.getElementById('bio').textContent = userData.bio;
                    document.getElementById('account-age').textContent = userData.account_age_days;
                    document.getElementById('followers').textContent = userData.followers;
                    document.getElementById('profile-url').href = userData.html_url;
                    
                    // 清除URL中的code参数
                    window.history.replaceState({}, document.title, window.location.pathname);
                })
                .catch(error => {
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').textContent = '错误: ' + error.message;
                });
        }
    </script>
</body>
</html>